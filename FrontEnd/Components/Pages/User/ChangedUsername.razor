@page "/changedUsername"

@using System.Security.Claims
@using Microsoft.AspNetCore.Authentication
@using Microsoft.AspNetCore.Authentication.Cookies
@using System.Security.Cryptography
@using FrontEnd.ViewModel

@inject HttpClient httpClient
@inject NavigationManager navigationManager

@code {
    [CascadingParameter]
    public HttpContext httpContext { get; set; }

    [SupplyParameterFromQuery]
    private string actualUsername { get; set; }

    [SupplyParameterFromQuery]
    private string accessToken { get; set; }

    [SupplyParameterFromQuery]
    private string userId { get; set; }

    protected override async Task OnInitializedAsync() {
        await base.OnInitializedAsync();
        if(httpContext.User.Identity.IsAuthenticated) {

            await httpContext.SignOutAsync();

        }

        var claims = new List<Claim>{
                new Claim(ClaimTypes.Name, actualUsername),
                new Claim("token", accessToken),
                new Claim("id", userId)
            };

        ClaimsIdentity identity = new ClaimsIdentity(claims, CookieAuthenticationDefaults.AuthenticationScheme);
        ClaimsPrincipal principal = new ClaimsPrincipal(identity);

        await httpContext.SignInAsync(principal);

        navigationManager.NavigateTo("/");
    }

}
